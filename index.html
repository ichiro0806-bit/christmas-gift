<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ„ ç”Ÿæª¢èª²å¹³å®‰å¤œ ğŸ„ </title>

<style>
body {
  
  margin: 0;
  font-family: Arial, sans-serif;
  background: radial-gradient(circle, #145a32, #0b3d2e);
  color: white;
  text-align: center;
  overflow: hidden;
}

/* å•Ÿå‹•ç•«é¢ */
#startScreen {
  position: fixed;
  inset: 0;
  background: #0b3d2e;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#startScreen button {
  font-size: 32px;
  padding: 20px 50px;
  border-radius: 16px;
  border: none;
  background: #e74c3c;
  color: white;
}

h1 { font-size: 36px; margin-top: 36px; }
.sub-title {
  font-size: 24px;   /* å¯å†èª¿ï¼š22 / 26 éƒ½ OK */
  margin-top: 12px;
  opacity: 0.9;
}

button {
  font-size: 28px;
  padding: 16px 40px;
  margin: 10px;
  border: none;
  border-radius: 14px;
  background: #e74c3c;
  color: white;
  cursor: pointer;
}

button.tool.pink {
  background: #ff6fae;   /* ç²‰ç´…è‰² */
  color: white;
}

button.tool.pink:active {
  background: #ff4f9a;
}
  
button.secondary { background: #2980b9; }
button.gray { background: #555; }

#countdown { font-size: 120px; color: #f1c40f; margin-top: 10px; }
#card { font-size: 72px; margin-top: 24px; min-height: 90px; }
#left { font-size: 24px; opacity: 0.85; margin-top: 12px; }

/* é›ªèŠ± */
.snowflake {
  position: fixed;
  top: -10px;
  user-select: none;
  animation: fall linear infinite;
}
@keyframes fall { to { transform: translateY(110vh); } }

/* è–èª•è€äºº */
#santa {
  position: fixed;
  top: 80px;
  left: -300px;
  font-size: 64px;
  animation: fly 18s linear infinite;
  pointer-events: none;
  z-index: 1;
}
@keyframes fly { to { transform: translateX(120vw); } }

/* ğŸ† ç…™ç«ç•«å¸ƒ */
#fx{
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 9998;
}
  /* ä¸»æŒ‰éˆ•å€ */
.main-btn {
  margin-top: 10px;
}

/* å°å·¥å…·åˆ—ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ */
.tool-bar {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 6px;
  flex-wrap: nowrap;
}

/* å°æŒ‰éˆ•æ¨£å¼ */
button.tool {
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 10px;
  background: #555;
}

/* æŠ•å½±æ¨¡å¼ä¸‹å·¥å…·åˆ—ä¹Ÿç¨å¾®æ”¾å¤§ */
.projector button.tool {
  font-size: 22px;
  padding: 12px 18px;
}

  /* ğŸ” å¯†ç¢¼é–€æ¨£å¼ */
#lockScreen {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle, #3b0a2a, #140010);
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

#lockScreen h1 {
  font-size: 28px;
  margin-bottom: 12px;
}

#lockScreen p {
  font-size: 18px;
  margin-bottom: 8px;
}

</style>
</head>

<body>

<canvas id="fx"></canvas>

<!-- ğŸ” å¯†ç¢¼é–€ -->
<div id="lockScreen">
  <h1>ğŸ” è«‹å…ˆå¤§å–Šæ—ä½³æ­£æ˜¯å¤§å¸¥å“¥</h1>
  <p>è«‹è¼¸å…¥æ´»å‹•å¯†ç¢¼</p>

  <input
    id="pwdInput"
    type="password"
    placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
    style="font-size:20px;padding:10px;border-radius:8px;border:none;"
  />

  <br><br>

  <button onclick="checkPassword()">é€²å…¥æ´»å‹• ğŸ„</button>

  <p id="pwdError" style="color:#ffb3b3;display:none;">å¯†ç¢¼éŒ¯èª¤</p>
</div>

  
<!-- å•Ÿå‹•ç•«é¢ -->
<div id="startScreen">
  <h1>ğŸ„ ç”Ÿæª¢èª²äº¤æ›ç¦®ç‰© ğŸ„</h1>
  <button onclick="start()">ğŸ‘‰ é»æˆ‘é–‹å§‹</button>
  <p>ï¼ˆè§£é–éŸ³æ•ˆ & äº’å‹•ï¼‰</p>
</div>

<h1>ğŸ„ ç”Ÿæª¢èª² ğŸ„</h1>
<h1 class="sub-title">ğŸæº«é¦¨æ„Ÿäººè¡Œæ†²ç´€å¿µæ—¥äº¤æ›ç¦®ç‰©ğŸ</h1>

<!-- ä¸»æŒ‰éˆ• -->
<div class="main-btn">
  <button id="btn" onclick="draw()">ğŸ æŒ‰æˆ‘ä¸­å¤§ç</button>
</div>

<!-- å°å·¥å…·åˆ— -->
<div class="tool-bar">
 <button class="tool pink" onclick="resetGame()">ğŸ” é‡ä¾†</button>
 <button class="tool pink" id="muteBtn" onclick="toggleMute()">ğŸ”Š éŸ³æ¨‚</button>
</div>


<div id="countdown"></div>
<div id="card"></div>
<div id="left"></div>

<div id="santa">ğŸ…ğŸ¦ŒğŸ¦ŒğŸ¦Œ</div>

<!-- ğŸµ èƒŒæ™¯éŸ³æ¨‚ -->
<audio id="bgm" src="./jb.mp3" loop preload="auto"></audio>
<!-- ğŸ”Š ç¿»ç‰ŒéŸ³æ•ˆ -->
<audio id="flipSound" src="./ass.mp3" preload="auto"></audio>
<!-- ğŸ”Š å€’æ•¸éŸ³æ•ˆ -->
<audio id="countSound" src="./ass.mp3" preload="auto"></audio>
<!-- ğŸ æœ€å¾Œä¸€äººéŸ³æ¨‚ -->
<audio id="finalSound" src="./final.mp3" preload="auto"></audio>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>

  // ğŸ” è¨­å®šæ´»å‹•å¯†ç¢¼ï¼ˆè‡ªå·±æ”¹é€™è£¡ï¼‰
const EVENT_PASSWORD = "byebye2025";

// æª¢æŸ¥å¯†ç¢¼
function checkPassword() {
  const input = document.getElementById("pwdInput").value;
  const error = document.getElementById("pwdError");

  if (input === EVENT_PASSWORD) {
    document.getElementById("lockScreen").style.display = "none";

    // å¯é¸ï¼šè¨˜ä½é€™å°è£ç½®ï¼ˆé‡æ–°æ•´ç†ä¸ç”¨å†è¼¸å…¥ï¼‰
    sessionStorage.setItem("xmasUnlocked", "1");
  } else {
    error.style.display = "block";
  }
}

// é‡æ–°æ•´ç†å¾Œè‡ªå‹•è§£é–ï¼ˆåŒä¸€åˆ†é ï¼‰
if (sessionStorage.getItem("xmasUnlocked") === "1") {
  window.addEventListener("load", () => {
    document.getElementById("lockScreen").style.display = "none";
  });
}

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBz2naDAZZP7PVSBJPKizGwCTZbVkuW0fE",
  authDomain: "christmas-3rdalc.firebaseapp.com",
  databaseURL: "https://christmas-3rdalc-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "christmas-3rdalc",
  storageBucket: "christmas-3rdalc.firebasestorage.app",
  messagingSenderId: "480438610552",
  appId: "1:480438610552:web:83397c3eb58ae9a747db8d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const rootRef = db.ref();

/* DOM */
const countdownEl = document.getElementById("countdown");
const cardEl = document.getElementById("card");
const leftEl = document.getElementById("left");

/* Audio */
const bgm = document.getElementById("bgm");
const flipSound = document.getElementById("flipSound");
const countSound = document.getElementById("countSound");
const finalSound = document.getElementById("finalSound");

let lastCountdown = 0;
let lastName = "";

/* éœéŸ³ */
let isMuted = false;

function applyMuteState() {
  bgm.muted = isMuted;
  flipSound.muted = isMuted;
  countSound.muted = isMuted;
  finalSound.muted = isMuted;

  const btn = document.getElementById("muteBtn");
  if (btn) btn.textContent = isMuted ? "ğŸ”‡ éœéŸ³" : "ğŸ”Š é–‹éŸ³æ¨‚";
}

function stopAllAudio() {
  [bgm, flipSound, countSound, finalSound].forEach(a => {
    try { a.pause(); a.currentTime = 0; } catch(e) {}
  });
}

function toggleMute() {
  isMuted = !isMuted;
  applyMuteState();

  if (isMuted) {
    stopAllAudio();
  } else {
    // å›åˆ°é–‹éŸ³ï¼šè‹¥å·²æŒ‰éã€Œé»æˆ‘é–‹å§‹ã€è§£é–éŸ³è¨Šï¼ŒèƒŒæ™¯éŸ³æ¨‚å¯æ¢å¾©
    bgm.play().catch(()=>{});
  }
}

function start() {
  document.getElementById("startScreen").style.display = "none";
  applyMuteState();

  bgm.volume = 0.2;
  bgm.currentTime = 0;
  if (!isMuted) bgm.play().catch(() => {});
}

/* æŠ½çï¼ˆåŒæ­¥å€’æ•¸ï¼‰ */
function draw() {
  rootRef.transaction(data => {
    if (!data) return data;

    if (!Array.isArray(data.names)) data.names = [];
    if (typeof data.drawing !== "boolean") data.drawing = false;
    if (typeof data.current !== "string") data.current = "";
    if (typeof data.countdown !== "number") data.countdown = 0;

    if (data.drawing || data.names.length === 0) return;

    data.drawing = true;
    data.current = "";
    data.countdown = 3;
    return data;
  }, (error, committed) => {
    if (error || !committed) return;

    let c = 3;
    const timer = setInterval(() => {
      c--;
      if (c > 0) {
        rootRef.update({ countdown: c });
      } else {
        clearInterval(timer);
        rootRef.transaction(data => {
          if (!data) return data;
          if (!Array.isArray(data.names)) data.names = [];

          if (data.names.length === 0) {
            data.drawing = false;
            data.countdown = 0;
            return data;
          }

          const idx = Math.floor(Math.random() * data.names.length);
          data.current = data.names.splice(idx, 1)[0];
          data.countdown = 0;
          data.drawing = false;
          return data;
        });
      }
    }, 1000);
  });
}

/* é‡ç½®ï¼ˆå›å¡«åå–®ï¼šFirebase éœ€è¦ fullNamesï¼‰ */
function resetGame() {
  rootRef.transaction(data => {
    if (!data) return data;
    const full = Array.isArray(data.fullNames) ? data.fullNames : [];
    data.names = [...full];
    data.current = "";
    data.drawing = false;
    data.countdown = 0;
    return data;
  });

  // æœ¬æ©Ÿç‹€æ…‹
  countdownEl.innerText = "";
  cardEl.innerText = "";
  leftEl.innerText = "å·²é‡ç½® ğŸ„";
  lastCountdown = 0;
  lastName = "";

  // é‡ç½®æ™‚å…ˆåœè²éŸ³ï¼ˆä¸å¼·åˆ¶è‡ªå‹•é‡æ’­ï¼Œé¿å…æ²’è§£é–éŸ³è¨Šçš„æ‰‹æ©Ÿå ±éŒ¯ï¼‰
  stopAllAudio();
  if (!isMuted) bgm.play().catch(()=>{});
}

/* é›ªèŠ± */
setInterval(() => {
  const s = document.createElement("div");
  s.className = "snowflake";
  s.innerText = "â„";
  s.style.left = Math.random() * window.innerWidth + "px";
  s.style.fontSize = (14 + Math.random() * 20) + "px";
  s.style.animationDuration = (5 + Math.random() * 5) + "s";
  document.body.appendChild(s);
  setTimeout(() => s.remove(), 10000);
}, 300);

/* ğŸ† ç…™ç«ï¼ˆå½©è‰²ï¼‰ */
const fx = document.getElementById("fx");
const ctx = fx.getContext("2d");

function resizeFx(){
  fx.width = Math.floor(window.innerWidth * devicePixelRatio);
  fx.height = Math.floor(window.innerHeight * devicePixelRatio);
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
}
window.addEventListener("resize", resizeFx);
resizeFx();

let particles = [];
let fxRunning = false;
const FIRE_COLORS = ["#ff5252","#ff9800","#ffeb3b","#4caf50","#03a9f4","#9c27b0","#ffffff"];

function burst(x, y, power=1){
  const n = Math.floor(60 * power);
  const color = FIRE_COLORS[Math.floor(Math.random() * FIRE_COLORS.length)];
  for(let i=0;i<n;i++){
    const a = Math.random() * Math.PI * 2;
    const sp = (2 + Math.random() * 4) * power;
    particles.push({ x, y, vx: Math.cos(a)*sp, vy: Math.sin(a)*sp - (1.5*power), life: 40+Math.random()*25, r: 2+Math.random()*2, color });
  }
  runFx();
}

function runFx(){
  if (fxRunning) return;
  fxRunning = true;
  (function tick(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    for (let i = particles.length - 1; i >= 0; i--){
      const p = particles[i];
      p.life -= 1;
      p.vy += 0.08;
      p.vx *= 0.99; p.vy *= 0.99;
      p.x += p.vx; p.y += p.vy;

      ctx.globalAlpha = Math.max(p.life / 60, 0);
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();

      if (p.life <= 0) particles.splice(i,1);
    }
    ctx.globalAlpha = 1;
    if (particles.length > 0) requestAnimationFrame(tick);
    else fxRunning = false;
  })();
}

function fireworksShow(){
  const rounds = 8;
  let k = 0;
  const timer = setInterval(()=>{
    k++;
    const x = 50 + Math.random()*(window.innerWidth-100);
    const y = 120 + Math.random()*(window.innerHeight*0.45);
    burst(x, y, 1.2);
    if (k >= rounds) clearInterval(timer);
  }, 250);
}

/* åŒæ­¥ç›£è½ï¼šç•«é¢ + éŸ³æ•ˆ + æœ€å¾Œä¸€äºº */
rootRef.on("value", snap => {
  const data = snap.val();
  if (!data) return;

  const namesLeft = Array.isArray(data.names) ? data.names.length : 0;
  leftEl.innerText = "å‰©ä¸‹ " + namesLeft + " äºº";

  if (data.countdown > 0) {
    countdownEl.innerText = data.countdown;
    cardEl.innerText = "";

    if (data.countdown !== lastCountdown) {
      if (!isMuted) {
        countSound.currentTime = 0;
        countSound.volume = 0.6;
        countSound.play().catch(() => {});
      }
      lastCountdown = data.countdown;
    }
    return;
  }

  countdownEl.innerText = "";
  lastCountdown = 0;

  if (data.current && data.current !== lastName) {
    cardEl.innerText = "ğŸ " + data.current;

    // æ¯æ¬¡æŠ½åˆ°ï¼šç…™ç«
    burst(window.innerWidth * 0.5, 140, 1);

    // ç¿»ç‰ŒéŸ³æ•ˆ
    if (!isMuted) {
      flipSound.currentTime = 0;
      flipSound.volume = 0.7;
      flipSound.play().catch(() => {});
    }

    // æœ€å¾Œä¸€äººï¼šå…ˆåœ bgm â†’ æ’­ final â†’ ç…™ç«ç§€
    if (namesLeft === 0) {
      bgm.pause();
      bgm.currentTime = 0;

      if (!isMuted) {
        finalSound.currentTime = 0;
        finalSound.volume = 0.9;
        finalSound.play().catch(() => {});
      }
      fireworksShow();
    }

    lastName = data.current;
  }

  if (!data.current) {
    cardEl.innerText = "";
    lastName = "";
  }
});

// åˆæ¬¡è¼‰å…¥å°±æŠŠæŒ‰éˆ•æ–‡å­—åŒæ­¥ä¸€æ¬¡
applyMuteState();
</script>

</body>
</html>






<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ„ è–èª•äº¤æ›ç¦®ç‰©ç¿»ç‰Œï¼ˆåŒæ­¥ç‰ˆï¼‰</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: radial-gradient(circle, #145a32, #0b3d2e);
  color: white;
  text-align: center;
  overflow: hidden;
}

/* å•Ÿå‹•ç•«é¢ */
#startScreen {
  position: fixed;
  inset: 0;
  background: #0b3d2e;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#startScreen button {
  font-size: 32px;
  padding: 20px 50px;
  border-radius: 16px;
  border: none;
  background: #e74c3c;
  color: white;
}

h1 { font-size: 36px; margin-top: 36px; }

button {
  font-size: 28px;
  padding: 16px 40px;
  margin: 10px;
  border: none;
  border-radius: 14px;
  background: #e74c3c;
  color: white;
  cursor: pointer;
}

button.secondary { background: #2980b9; }
button.gray { background: #555; }

#countdown { font-size: 120px; color: #f1c40f; margin-top: 10px; }
#card { font-size: 72px; margin-top: 24px; min-height: 90px; }
#left { font-size: 24px; opacity: 0.85; margin-top: 12px; }

/* æŠ•å½±æ¨¡å¼ */
.projector h1 { font-size: 80px; }
.projector #card { font-size: 140px; }
.projector #countdown { font-size: 180px; }
.projector button { font-size: 36px; }

/* é›ªèŠ± */
.snowflake {
  position: fixed;
  top: -10px;
  user-select: none;
  animation: fall linear infinite;
}
@keyframes fall { to { transform: translateY(110vh); } }

/* è–èª•è€äºº */
#santa {
  position: fixed;
  top: 80px;
  left: -300px;
  font-size: 64px;
  animation: fly 18s linear infinite;
  pointer-events: none;
  z-index: 1;
}
@keyframes fly { to { transform: translateX(120vw); } }
.projector #santa { font-size: 96px; top: 120px; }

/* ğŸ† ç…™ç«ç•«å¸ƒ */
#fx{
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 9998;
}
</style>
</head>

<body>

<!-- ğŸ† æ­£ç¢ºä½ç½®ï¼šæ”¾åœ¨ body è£¡ï¼ˆä¸è¦æ”¾åœ¨ style è£¡ï¼‰ -->
<canvas id="fx"></canvas>

<!-- å•Ÿå‹•ç•«é¢ -->
<div id="startScreen">
  <h1>ğŸ„ ç”Ÿæª¢èª²äº¤æ›ç¦®ç‰© ğŸ„</h1>
  <button onclick="start()">ğŸ‘‰ é»æˆ‘é–‹å§‹</button>
  <p>ï¼ˆè§£é–éŸ³æ•ˆ & äº’å‹•ï¼‰</p>
</div>

<h1>ğŸ„ ç”Ÿæª¢èª² ğŸ„</h1>
<h1> ğŸæº«é¦¨æ„Ÿäººè¡Œæ†²ç´€å¿µæ—¥äº¤æ›ç¦®ç‰©ğŸ </h1>

<div>
  <button id="btn" onclick="draw()">ğŸ æŒ‰æˆ‘ä¸­å¤§ç</button>
  <button class="secondary" onclick="toggleProjector()">ğŸ–¥ æŠ•å½±æ¨¡å¼</button>
  <button class="gray" onclick="resetGame()">ğŸ” é‡æ–°é–‹å§‹</button>
</div>

<div id="countdown"></div>
<div id="card"></div>
<div id="left"></div>

<div id="santa">ğŸ…ğŸ¦ŒğŸ¦ŒğŸ¦Œ</div>

<!-- ğŸµ èƒŒæ™¯éŸ³æ¨‚ -->
<audio id="bgm" src="./jb.mp3" loop preload="auto"></audio>

<!-- ğŸ”Š ç¿»ç‰ŒéŸ³æ•ˆï¼ˆåå­—å‡ºç¾ç¬é–“ï¼‰ -->
<audio id="flipSound" src="./ass.mp3" preload="auto"></audio>

<!-- ğŸ”Š å€’æ•¸åŒæ­¥éŸ³æ•ˆï¼ˆ3/2/1 æ¯è·³ä¸€æ¬¡ï¼‰ -->
<audio id="countSound" src="./ass.mp3" preload="auto"></audio>

<!-- ğŸ æœ€å¾Œä¸€äººéŸ³æ¨‚ -->
<audio id="finalSound" src="./final.mp3" preload="auto"></audio>

<!-- âœ… Firebase SDKï¼ˆä¸€å®šè¦åœ¨ä½¿ç”¨ db ä¹‹å‰ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ğŸ”‘ ä½ çš„ firebaseConfigï¼ˆåŸæ¨£ä¿ç•™ï¼‰ */
const firebaseConfig = {
  apiKey: "AIzaSyBz2naDAZZP7PVSBJPKizGwCTZbVkuW0fE",
  authDomain: "christmas-3rdalc.firebaseapp.com",
  databaseURL: "https://christmas-3rdalc-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "christmas-3rdalc",
  storageBucket: "christmas-3rdalc.firebasestorage.app",
  messagingSenderId: "480438610552",
  appId: "1:480438610552:web:83397c3eb58ae9a747db8d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const rootRef = db.ref();

/* DOM */
const countdownEl = document.getElementById("countdown");
const cardEl = document.getElementById("card");
const leftEl = document.getElementById("left");

/* éŸ³æ•ˆ */
const bgm = document.getElementById("bgm");
const flipSound = document.getElementById("flipSound");
const countSound = document.getElementById("countSound");
const finalSound = document.getElementById("finalSound");

/* é¿å…ç›£è½é‡è¤‡æ’­éŸ³æ•ˆ */
let lastCountdown = 0;
let lastName = "";

/* é»æˆ‘é–‹å§‹ï¼šæ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ï¼ˆç¬¦åˆæ‰‹æ©Ÿè¦å‰‡ï¼šç”¨æˆ¶é»æ“Šè§¸ç™¼ï¼‰ */
function start() {
  document.getElementById("startScreen").style.display = "none";
  bgm.volume = 0.2;
  bgm.currentTime = 0;
  bgm.play().catch(() => {});
}

/* Aï¼šèª°éƒ½èƒ½æŒ‰ã€ç¬¬ä¸€å€‹æœ‰æ•ˆ + åŒæ­¥å€’æ•¸ */
function draw() {
  rootRef.transaction(data => {
    if (!data) return data;

    if (!Array.isArray(data.names)) data.names = [];
    if (typeof data.drawing !== "boolean") data.drawing = false;
    if (typeof data.current !== "string") data.current = "";
    if (typeof data.countdown !== "number") data.countdown = 0;

    if (data.drawing || data.names.length === 0) return;

    data.drawing = true;
    data.current = "";
    data.countdown = 3;
    return data;
  }, (error, committed) => {
    if (error || !committed) return;

    let c = 3;
    const timer = setInterval(() => {
      c--;
      if (c > 0) {
        rootRef.update({ countdown: c });
      } else {
        clearInterval(timer);

        rootRef.transaction(data => {
          if (!data) return data;
          if (!Array.isArray(data.names)) data.names = [];

          if (data.names.length === 0) {
            data.drawing = false;
            data.countdown = 0;
            return data;
          }

          const idx = Math.floor(Math.random() * data.names.length);
          data.current = data.names.splice(idx, 1)[0];
          data.countdown = 0;
          data.drawing = false;
          return data;
        });
      }
    }, 1000);
  });
}

/* é‡ç½®ï¼šå›å¡«åå–®ï¼ˆéœ€è¦ Firebase æœ‰ fullNamesï¼‰ */
function resetGame() {
  rootRef.transaction(data => {
    if (!data) return data;
    const full = Array.isArray(data.fullNames) ? data.fullNames : [];
    data.names = [...full];
    data.current = "";
    data.drawing = false;
    data.countdown = 0;
    return data;
  });

  countdownEl.innerText = "";
  cardEl.innerText = "";
  leftEl.innerText = "å·²é‡ç½® ğŸ„";
  lastCountdown = 0;
  lastName = "";
}

/* æŠ•å½±æ¨¡å¼ */
function toggleProjector() {
  document.body.classList.toggle("projector");
}

/* â„ï¸ é›ªèŠ± */
setInterval(() => {
  const s = document.createElement("div");
  s.className = "snowflake";
  s.innerText = "â„";
  s.style.left = Math.random() * window.innerWidth + "px";
  s.style.fontSize = (14 + Math.random() * 20) + "px";
  s.style.animationDuration = (5 + Math.random() * 5) + "s";
  document.body.appendChild(s);
  setTimeout(() => s.remove(), 10000);
}, 300);

/* ğŸ† ç…™ç«ï¼ˆå½©è‰²ï¼‰ */
const fx = document.getElementById("fx");
const ctx = fx.getContext("2d");

function resizeFx(){
  fx.width = Math.floor(window.innerWidth * devicePixelRatio);
  fx.height = Math.floor(window.innerHeight * devicePixelRatio);
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
}
window.addEventListener("resize", resizeFx);
resizeFx();

let particles = [];
let fxRunning = false;

const FIRE_COLORS = ["#ff5252","#ff9800","#ffeb3b","#4caf50","#03a9f4","#9c27b0","#ffffff"];

function burst(x, y, power=1){
  const n = Math.floor(60 * power);
  const color = FIRE_COLORS[Math.floor(Math.random() * FIRE_COLORS.length)];

  for(let i=0;i<n;i++){
    const a = Math.random() * Math.PI * 2;
    const sp = (2 + Math.random() * 4) * power;
    particles.push({
      x, y,
      vx: Math.cos(a) * sp,
      vy: Math.sin(a) * sp - (1.5 * power),
      life: 40 + Math.random()*25,
      r: 2 + Math.random()*2,
      color
    });
  }
  runFx();
}

function runFx(){
  if (fxRunning) return;
  fxRunning = true;

  (function tick(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    for (let i = particles.length - 1; i >= 0; i--){
      const p = particles[i];
      p.life -= 1;
      p.vy += 0.08;
      p.vx *= 0.99;
      p.vy *= 0.99;
      p.x += p.vx;
      p.y += p.vy;

      ctx.globalAlpha = Math.max(p.life / 60, 0);
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();

      if (p.life <= 0) particles.splice(i,1);
    }
    ctx.globalAlpha = 1;

    if (particles.length > 0){
      requestAnimationFrame(tick);
    } else {
      fxRunning = false;
    }
  })();
}

function fireworksShow(){
  const rounds = 8;
  let k = 0;
  const timer = setInterval(()=>{
    k++;
    const x = 50 + Math.random()*(window.innerWidth-100);
    const y = 120 + Math.random()*(window.innerHeight*0.45);
    burst(x, y, 1.2);
    if (k >= rounds) clearInterval(timer);
  }, 250);
}

/* ğŸ”„ ç›£è½é›²ç«¯ç‹€æ…‹ï¼ˆåŒæ­¥æ›´æ–°ç•«é¢ + åŒæ­¥æ’­éŸ³æ•ˆ + åŒæ­¥ç…™ç«/æœ€å¾Œä¸€äººï¼‰ */
rootRef.on("value", snap => {
  const data = snap.val();
  if (!data) return;

  const namesLeft = Array.isArray(data.names) ? data.names.length : 0;
  leftEl.innerText = "å‰©ä¸‹ " + namesLeft + " äºº";

  if (data.countdown > 0) {
    countdownEl.innerText = data.countdown;
    cardEl.innerText = "";

    if (data.countdown !== lastCountdown) {
      countSound.currentTime = 0;
      countSound.volume = 0.6;
      countSound.play().catch(() => {});
      lastCountdown = data.countdown;
    }
    return;
  }

  countdownEl.innerText = "";
  lastCountdown = 0;

  if (data.current && data.current !== lastName) {
    cardEl.innerText = "ğŸ " + data.current;

    // ğŸ† æ¯æ¬¡æŠ½åˆ°éƒ½æ”¾ä¸€ç™¼ç…™ç«
    burst(window.innerWidth * 0.5, 140, 1);

    // ğŸ”Š åŒæ­¥ç¿»ç‰ŒéŸ³æ•ˆ
    flipSound.currentTime = 0;
    flipSound.volume = 0.7;
    flipSound.play().catch(() => {});

    // ğŸ æœ€å¾Œä¸€äººï¼šfinal.mp3 + é€£çºŒç…™ç«ç§€
    if (namesLeft === 0) {
      finalSound.currentTime = 0;
      finalSound.volume = 0.8;
      finalSound.play().catch(() => {});
      fireworksShow();
    }

    lastName = data.current;
  }

  if (!data.current) {
    cardEl.innerText = "";
    lastName = "";
  }
});
</script>

</body>
</html>

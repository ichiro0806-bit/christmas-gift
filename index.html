<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ„ è–èª•äº¤æ›ç¦®ç‰©ç¿»ç‰Œï¼ˆåŒæ­¥ç‰ˆï¼‰</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: radial-gradient(circle, #145a32, #0b3d2e);
  color: white;
  text-align: center;
  overflow: hidden;
}

/* å•Ÿå‹•ç•«é¢ */
#startScreen {
  position: fixed;
  inset: 0;
  background: #0b3d2e;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#startScreen button {
  font-size: 32px;
  padding: 20px 50px;
  border-radius: 16px;
  border: none;
  background: #e74c3c;
  color: white;
}

h1 { font-size: 44px; margin-top: 36px; }

button {
  font-size: 28px;
  padding: 16px 40px;
  margin: 10px;
  border: none;
  border-radius: 14px;
  background: #e74c3c;
  color: white;
  cursor: pointer;
}

button.secondary { background: #2980b9; }
button.gray { background: #555; }

#countdown { font-size: 120px; color: #f1c40f; margin-top: 10px; }
#card { font-size: 72px; margin-top: 24px; min-height: 90px; }
#left { font-size: 24px; opacity: 0.85; margin-top: 12px; }

/* æŠ•å½±æ¨¡å¼ */
.projector h1 { font-size: 80px; }
.projector #card { font-size: 140px; }
.projector #countdown { font-size: 180px; }
.projector button { font-size: 36px; }

/* é›ªèŠ± */
.snowflake {
  position: fixed;
  top: -10px;
  user-select: none;
  animation: fall linear infinite;
}
@keyframes fall { to { transform: translateY(110vh); } }

/* è–èª•è€äºº */
#santa {
  position: fixed;
  top: 80px;
  left: -300px;
  font-size: 64px;
  animation: fly 18s linear infinite;
  pointer-events: none;
  z-index: 1;
}
@keyframes fly { to { transform: translateX(120vw); } }

.projector #santa { font-size: 96px; top: 120px; }
</style>
</head>

<body>

<!-- å•Ÿå‹•ç•«é¢ -->
<div id="startScreen">
  <h1>ğŸ„ è–èª•äº¤æ›ç¦®ç‰© ğŸ„</h1>
  <button onclick="start()">ğŸ‘‰ é»æˆ‘é–‹å§‹</button>
  <p>ï¼ˆè§£é–éŸ³æ•ˆ & äº’å‹•ï¼‰</p>
</div>

<h1>ğŸ„ ç”Ÿæª¢èª²æº«é¦¨æ„Ÿäººè¡Œæ†²ç´€å¿µæ—¥äº¤æ›ç¦®ç‰© ğŸ„</h1>

<div>
  <button id="btn" onclick="draw()">ğŸ æŒ‰æˆ‘ä¸­å¤§ç</button>
  <button class="secondary" onclick="toggleProjector()">ğŸ–¥ æŠ•å½±æ¨¡å¼</button>
  <button class="gray" onclick="resetGame()">ğŸ” é‡æ–°é–‹å§‹</button>
</div>

<div id="countdown"></div>
<div id="card"></div>
<div id="left"></div>

<div id="santa">ğŸ…ğŸ¦ŒğŸ¦ŒğŸ¦Œ</div>

<!-- ğŸµ èƒŒæ™¯éŸ³æ¨‚ -->
<audio id="bgm" src="./jb.mp3" loop preload="auto"></audio>

<!-- ğŸ”Š ç¿»ç‰ŒéŸ³æ•ˆï¼ˆåå­—å‡ºç¾ç¬é–“ï¼‰ -->
<audio id="flipSound" src="./ass.mp3" preload="auto"></audio>

<!-- ğŸ”Š å€’æ•¸åŒæ­¥éŸ³æ•ˆï¼ˆ3/2/1 æ¯è·³ä¸€æ¬¡ï¼‰ -->
<audio id="countSound" src="./ass.mp3" preload="auto"></audio>

<!-- âœ… Firebase SDKï¼ˆä¸€å®šè¦åœ¨ä½¿ç”¨ db ä¹‹å‰ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ğŸ”‘ ä½ çš„ firebaseConfigï¼ˆåŸæ¨£ä¿ç•™ï¼‰ */
const firebaseConfig = {
  apiKey: "AIzaSyBz2naDAZZP7PVSBJPKizGwCTZbVkuW0fE",
  authDomain: "christmas-3rdalc.firebaseapp.com",
  databaseURL: "https://christmas-3rdalc-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "christmas-3rdalc",
  storageBucket: "christmas-3rdalc.firebasestorage.app",
  messagingSenderId: "480438610552",
  appId: "1:480438610552:web:83397c3eb58ae9a747db8d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const rootRef = db.ref();

/* DOM */
const countdownEl = document.getElementById("countdown");
const cardEl = document.getElementById("card");
const leftEl = document.getElementById("left");

/* éŸ³æ•ˆ */
const bgm = document.getElementById("bgm");
const flipSound = document.getElementById("flipSound");
const countSound = document.getElementById("countSound");

/* ç”¨æ–¼é¿å…ç›£è½é‡è¤‡æ’­éŸ³æ•ˆ */
let lastCountdown = 0;
let lastName = "";

/* é»æˆ‘é–‹å§‹ï¼šæ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ï¼ˆç¬¦åˆæ‰‹æ©Ÿè¦å‰‡ï¼šç”¨æˆ¶é»æ“Šè§¸ç™¼ï¼‰ */
function start() {
  document.getElementById("startScreen").style.display = "none";
  bgm.volume = 0.2;
  bgm.currentTime = 0;
  bgm.play().catch(() => {});
}

/* Aï¼šèª°éƒ½èƒ½æŒ‰ã€ç¬¬ä¸€å€‹æœ‰æ•ˆ + åŒæ­¥å€’æ•¸ */
function draw() {
  // å…ˆç”¨ transaction æ¶é–
  rootRef.transaction(data => {
    if (!data) return data;

    // éœ€è¦ Firebase è£¡æœ‰ï¼šnames / drawing / current / countdown
    if (!Array.isArray(data.names)) data.names = [];
    if (typeof data.drawing !== "boolean") data.drawing = false;
    if (typeof data.current !== "string") data.current = "";
    if (typeof data.countdown !== "number") data.countdown = 0;

    // å·²æœ‰äººåœ¨æŠ½ or æŠ½å®Œäº†
    if (data.drawing || data.names.length === 0) return;

    // ä¸Šé– + åˆå§‹åŒ–å€’æ•¸
    data.drawing = true;
    data.current = "";
    data.countdown = 3;
    return data;
  }, (error, committed) => {
    if (error || !committed) return; // æ²’æ¶åˆ°é–å°±ä¸åšä»»ä½•äº‹

    // å€’æ•¸ç”±é›²ç«¯æ¬„ä½é©…å‹•ï¼ˆåŒæ­¥ï¼‰
    let c = 3;
    const timer = setInterval(() => {
      c--;

      if (c > 0) {
        rootRef.update({ countdown: c });
      } else {
        clearInterval(timer);

        // å€’æ•¸åˆ° 0ï¼šæŠ½äºº + è§£é–
        rootRef.transaction(data => {
          if (!data) return data;
          if (!Array.isArray(data.names)) data.names = [];
          if (data.names.length === 0) {
            data.drawing = false;
            data.countdown = 0;
            return data;
          }

          const idx = Math.floor(Math.random() * data.names.length);
          data.current = data.names.splice(idx, 1)[0];
          data.countdown = 0;
          data.drawing = false;
          return data;
        });
      }
    }, 1000);
  });
}

/* é‡ç½®ï¼šæŠŠ Firebase å›åˆ°åˆå§‹ç‹€æ…‹ï¼ˆè«‹å…ˆåœ¨ Firebase Data ä¸­æ”¾å¥½ names åå–®ï¼‰ */
function resetGame() {
  // é€™è£¡ä¸ç›´æ¥å¯«æ­»åå–®ï¼Œé¿å…ä½ æ¯æ¬¡æ”¹åå–®éƒ½è¦æ”¹ç¨‹å¼
  // åªæŠŠç‹€æ…‹æ¸…ç©ºï¼Œnames ä¿æŒ Firebase ç¾æœ‰å…§å®¹
  rootRef.update({
    current: "",
    drawing: false,
    countdown: 0
  });

  // æœ¬åœ°é¡¯ç¤ºå…ˆæ¸…ä¸€ä¸‹ï¼ˆé«”æ„Ÿæ›´å¥½ï¼‰
  countdownEl.innerText = "";
  cardEl.innerText = "";
  leftEl.innerText = "å·²é‡ç½® ğŸ„";
  lastCountdown = 0;
  lastName = "";
}

/* æŠ•å½±æ¨¡å¼ */
function toggleProjector() {
  document.body.classList.toggle("projector");
}

/* â„ï¸ é›ªèŠ± */
setInterval(() => {
  const s = document.createElement("div");
  s.className = "snowflake";
  s.innerText = "â„";
  s.style.left = Math.random() * window.innerWidth + "px";
  s.style.fontSize = (14 + Math.random() * 20) + "px";
  s.style.animationDuration = (5 + Math.random() * 5) + "s";
  document.body.appendChild(s);
  setTimeout(() => s.remove(), 10000);
}, 300);

/* ğŸ”„ ç›£è½é›²ç«¯ç‹€æ…‹ï¼ˆåŒæ­¥æ›´æ–°ç•«é¢ + åŒæ­¥æ’­éŸ³æ•ˆï¼‰ */
rootRef.on("value", snap => {
  const data = snap.val();
  if (!data) return;

  const namesLeft = Array.isArray(data.names) ? data.names.length : 0;
  leftEl.innerText = "å‰©ä¸‹ " + namesLeft + " äºº";

  // åŒæ­¥å€’æ•¸é¡¯ç¤º + åŒæ­¥å€’æ•¸éŸ³æ•ˆ
  if (data.countdown > 0) {
    countdownEl.innerText = data.countdown;
    cardEl.innerText = "";

    if (data.countdown !== lastCountdown) {
      countSound.currentTime = 0;
      countSound.volume = 0.6;
      countSound.play().catch(() => {});
      lastCountdown = data.countdown;
    }
    return;
  }

  // å€’æ•¸çµæŸ
  countdownEl.innerText = "";
  lastCountdown = 0;

  // åå­—å‡ºç¾ï¼šåŒæ­¥ç¿»ç‰ŒéŸ³æ•ˆ
  if (data.current && data.current !== lastName) {
    cardEl.innerText = "ğŸ " + data.current;

    flipSound.currentTime = 0;
    flipSound.volume = 0.7;
    flipSound.play().catch(() => {});

    lastName = data.current;
  }

  // è‹¥ current è¢«æ¸…ç©ºï¼Œä¹ŸåŒæ­¥æ¸…ç•«é¢
  if (!data.current) {
    cardEl.innerText = "";
    lastName = "";
  }
});
</script>

</body>
</html>

